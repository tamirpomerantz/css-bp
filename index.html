<!-- 
TODO:
zero state show all variables
 -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m.css - Minimalist CSS Framework</title>
    <link rel="stylesheet" href="page.css">
    <link rel="stylesheet" href="m.css">
    <style>
        .class-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 450px;
            height: 100vh;
            background: var(--color-background);
            border-left: 1px solid var(--color-border);
            transform: translateX(0); /* Always visible */
            z-index: 1000;
            overflow-y: auto;
            resize: horizontal;
            min-width: 250px;
            max-width: 600px;
        }

        .class-panel::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            cursor: ew-resize;
            background: transparent;
        }

        .class-panel.resizing {
            user-select: none;
            cursor: ew-resize;
        }

        [contenteditable] {
            outline: 1px dashed transparent;
            transition: outline-color 0.2s ease;
            cursor: pointer;
        }

        [contenteditable]:hover {
            outline-color: var(--color-primary);
        }

        [contenteditable]:focus {
            outline: 2px solid var(--color-primary);
        }

        .class-tag {
            display: inline-block;
            padding: 4px 8px;
            background: var(--color-background-alt);
            border-radius: var(--radius-s);
            margin: 4px;
            font-size: var(--font-size-s);
        }

        .element-tree {
            width: 100%;
            padding: 30px;
            font-size: var(--font-size-button);
            color: var(--color-text-lite);
            display: flex;
            gap: 8px;
            flex-direction: column;
            background-color: color-mix(in srgb, var(--color-base) 12%, transparent);;
        }

        .element-tree-item {
            display: block;
        }

        .element-tree-item.active {
            color: var(--color-primary);
            font-weight: bold;
        }

        .tree-item {
            display: flex;
    align-items: center;
    flex-direction: row;
    justify-content: flex-start;        }

        /* .selected-classes {
            margin-top: var(--spacing-m);
            padding-top: var(--spacing-s);
            border-top: 1px solid var(--color-border);
        } */

        /* Update body margin to use CSS variable */
        body {
            margin-right: var(--panel-width, 450px);
            transition: margin-right 0.1s ease;
        }

        .variables-list {
     
        }

        .variable-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-xs) 0;
            gap: var(--spacing-m);
        }

        .variable-name {
            color: var(--color-primary);
            /* font-family: monospace; */
            font-size: var(--font-size-small);
        }

        .variable-value {
            color: var(--color-text-secondary);
            text-align: right;
        }

        .variable-overrides {
            padding-top: var(--spacing-l);
        }

        .override-control {
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
            margin-bottom: var(--spacing-s);
        }

        .variables-list, .variable-overrides, .main-colors {
            padding: var(--spacing-l);
        }

        .variables-list {
            background-color: color-mix(in srgb, var(--color-base) 9%, transparent);
            font-size: var(--font-size-small);
            color: var(--color-text-lite);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-s);
        }

        .variable-overrides {
            background-color: color-mix(in srgb, var(--color-base) 5%, transparent);
        }
        .main-colors {
            background-color: color-mix(in srgb, var(--color-base) 0%, transparent);
        }
        .class-section {
            /* padding-bottom: var(--spacing-m); */
        }
        .padding-bottom {
            padding-bottom: var(--spacing-s);
        }


        .override-inputs {
            display: flex;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-xs);
        }

        .variable-input, .color-input {
            width: 100px;
            text-align: right;
        }
        input {
            padding: var(--spacing-xs) var(--spacing-s);
            border: 1px solid transparent;
            border-radius: var(--radius-s);
            background: var(--color-background-alt);
            color: var(--color-text);
            font-size: var(--font-size-small);
            transition: var(--transition-fast);
  
        }
        input:hover {
            border-color: var(--color-primary);
        }
        input:focus {
            outline: none;
            border-color: var(--color-primary);
        }


        .color-control {
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
            margin-bottom: var(--spacing-s);
        }

        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid var(--color-border);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .color-dot input[type="color"] {
            position: absolute;
            top: -4px;
            left: -4px;
            width: 28px;
            height: 28px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
        }

        .color-dot input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-dot input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .color-dot input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 50%;
        }

        .color-name {
            flex: 1;
            color: var(--color-primary);
            /* font-family: monospace; */
            font-size: var(--font-size-small);
        }

        .clickable-tag {
            cursor: pointer;
            transition: var(--transition-fast);
            outline: 1px solid transparent

        }

        .clickable-tag:hover {
            /* background: var(--color-primary); */
            /* color: var(--color-text-negative); */
            outline: 1px solid var(--color-primary);
        }

        .clickable-tag.active {
            background: var(--color-primary);
            color: var(--color-text-negative);
        }

    
        .indent {
            color:transparent
        }
        .indent-arrow {
            padding-right: var(--spacing-xs);
        }
        .ellipsis {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

      


        .mono-font {
            font-family: monospace;
            font-family: "JetBrains Mono", serif;
        }
    </style>
</head>
<body>
    <div class="class-panel" contenteditable="false">
        <div id="elementTree" class="element-tree"></div>
        <!-- <div class="selected-classes">
            <h4 class="text-small">Selected Element Classes</h4>
            <div id="classDisplay" class="text-small"></div>
        </div> -->
        <div class="css-variables">
            <!-- <h4 class="text-small">CSS Variables</h4> -->
            <div id="variablesDisplay" class="variables-list mono-font"></div>
        </div>
        <div class="main-colors">
            <h4 class="text-small text-color-secondary mono-font padding-bottom">Main Colors</h4>
            <div class="color-control">
                <div class="color-dot">
                    <input type="color" data-variable="--color-black" value="#010c0f">
                </div>
                <span class="color-name mono-font">--color-black</span>
                <input type="text" data-variable="--color-black" class="color-input mono-font" value="#010c0f">
            </div>
            <div class="color-control">
                <div class="color-dot">
                    <input type="color" data-variable="--color-spark" value="#FB5010">
                </div>
                <span class="color-name mono-font">--color-spark</span>
                <input type="text" data-variable="--color-spark" class="color-input mono-font" value="#FB5010">
            </div>
            <div class="color-control">
                <div class="color-dot">
                    <input type="color" data-variable="--color-white" value="#FFFFFF">
                </div>
                <span class="color-name mono-font">--color-white</span>
                <input type="text" data-variable="--color-white" class="color-input mono-font" value="#FFFFFF">
            </div>
        </div>
      
    </div>

    <header class="header" contenteditable="true" data-classes="header">
        <div class="container header__container" contenteditable="true" data-classes="container header__container">
            <a href="/" class="header__logo" contenteditable="true" data-classes="header__logo">m.css</a>
            <nav class="header__nav" contenteditable="true" data-classes="header__nav">
                <ul class="header__nav-list" contenteditable="true" data-classes="header__nav-list">
                    <li><a href="#features" class="button button--link text-small" contenteditable="true" data-classes="button button--link text-small">Features</a></li>
                    <li><a href="#components" class="button button--link text-small" contenteditable="true" data-classes="button button--link text-small">Components</a></li>
                    <li><a href="#start" class="button button--link text-small" contenteditable="true" data-classes="button button--link text-small">Get Started</a></li>
                </ul>
            </nav>
            <div class="header__cta" contenteditable="true" data-classes="header__cta">
                <a href="" class="button button--primary text-small download-button" contenteditable="true" data-classes="button button--primary text-small">Download CSS</a>
            </div>
        </div>
    </header>

    <main>
        <section class="hero" contenteditable="true" data-classes="hero">
            <div class="container hero__container" contenteditable="true" data-classes="container hero__container">
                <div class="hero__content" contenteditable="true" data-classes="hero__content">
                    <h3 class="text-small text-color-secondary" contenteditable="true" data-classes="text-small text-color-secondary">Interactive CSS Framework</h3>
                    <h1 class="hero__title text-title-xl" contenteditable="true" data-classes="hero__title text-title-xl">Design Systems, Reimagined</h1>
                    <p class="hero__subtitle text-title" contenteditable="true" data-classes="hero__subtitle text-title">Create your perfect CSS foundation with real-time customization. Edit variables, see live changes, and generate your ideal boilerplate in seconds.</p>
                    <div class="hero__buttons" contenteditable="true" data-classes="hero__buttons">
                        <button class="button button--primary button--large text-small" contenteditable="true" data-classes="button button--primary button--large text-small">Start Customizing</button>
                        <button class="button button--ghost button--large text-small" contenteditable="true" data-classes="button button--ghost button--large text-small">Watch Demo</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="features" id="features">
            <div class="container">
                <h2 class="features__title text-title text-center">The Future of CSS Customization</h2>
                <div class="features__grid">
                    <div class="feature-card">
                        <div class="feature-card__icon">👀</div>
                        <h3 class="feature-card__title text-title">Live Preview</h3>
                        <p class="text-body">See your changes instantly as you customize variables. No more switching between files or refreshing the browser.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-card__icon">🎨</div>
                        <h3 class="feature-card__title text-title">Visual Editor</h3>
                        <p class="text-body">Intuitive interface for editing colors, spacing, typography, and more. Perfect for designers and developers alike.</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-card__icon">⚡️</div>
                        <h3 class="feature-card__title text-title">Instant Export</h3>
                        <p class="text-body">Generate your customized CSS file with one click. No build process needed - just download and use.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="how-it-works" id="components">
            <div class="container">
                <h2 class="how-it-works__title text-title-l text-center">Customize in Three Steps</h2>
                <div class="steps">
                    <div class="step">
                        <div class="step__number">1</div>
                        <h3 class="text-title-s">Select Elements</h3>
                        <p class="text-body">Click any element to see its CSS variables and customization options in the side panel.</p>
                    </div>
                    <div class="step">
                        <div class="step__number">2</div>
                        <h3 class="text-title-s">Edit Variables</h3>
                        <p class="text-body">Adjust colors, spacing, and other properties with our intuitive controls. See changes instantly.</p>
                    </div>
                    <div class="step">
                        <div class="step__number">3</div>
                        <h3 class="text-title-s">Export & Use</h3>
                        <p class="text-body">Download your customized CSS file and integrate it into your project. No dependencies required.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="cta-section" id="start">
            <div class="container">
                <div class="cta-box color-scheme-reverse">
                    <h2 class="cta-box__title text-title">Create Your Perfect CSS</h2>
                    <p class="cta-box__text text-body">Stop wrestling with CSS variables. Start customizing your design system visually.</p>
                    <div class="cta-box__buttons">
                        <button class="button button--primary button--large text-small">Try it Now</button>
                        <button class="button button--secondary button--large text-small">View Source</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container footer__container">
            <div class="footer__brand">
                <a href="/" class="footer__logo">m.css</a>
                <p class="footer__tagline text-small">Simple. Powerful. Customizable.</p>
            </div>
            <div class="footer__links">
                <div class="footer__column">
                    <h4 class="footer__heading text-small">Contact</h4>
                    <ul class="footer__list">
                        <li><a href="#" class="footer__link text-small">tamirp.com</a></li>
                        <li><a href="#" class="footer__link text-small">tamirp@gmail.com</a></li>
                        <li><a href="#" class="footer__link text-small">@tamirpo</a></li>
                    </ul>
                </div>
           
            </div>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.querySelector('.class-panel');
            const classDisplay = document.getElementById('classDisplay');
            const elementTree = document.getElementById('elementTree');
            const variablesDisplay = document.getElementById('variablesDisplay');
            
            let cssContent = '';
            let cssLoaded = false;
            let currentVariablesByClass = null;
            let activeFilter = null;

            // Add resize functionality
            let isResizing = false;
            let startX;
            let startWidth;

            function initResize(e) {
                // Only start resize if clicking near the left edge
                const clickPosition = e.clientX - panel.getBoundingClientRect().left;
                if (clickPosition > 10) return; // Only allow resize within 10px of the left edge

                isResizing = true;
                startX = e.clientX;
                startWidth = parseInt(getComputedStyle(panel).width, 10);
                
                panel.classList.add('resizing');
                
                // Prevent text selection while resizing
                document.body.style.userSelect = 'none';
                
                // Add event listeners for drag and end
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            }

            function resize(e) {
                if (!isResizing) return;
                
                const width = startWidth - (e.clientX - startX);
                const newWidth = Math.min(Math.max(250, width), 600);
                
                panel.style.width = `${newWidth}px`;
                document.documentElement.style.setProperty('--panel-width', `${newWidth}px`);
            }

            function stopResize() {
                isResizing = false;
                panel.classList.remove('resizing');
                document.body.style.userSelect = '';
                
                // Remove event listeners
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }

            // Initialize panel width CSS variable
            document.documentElement.style.setProperty('--panel-width', '450px');
            
            // Add mouse down event listener to panel
            panel.addEventListener('mousedown', initResize);

            // Load CSS file content
            async function loadCSSContent() {
                if (cssLoaded) return;
                
                try {
                    // Try to load both CSS files
                    const responses = await Promise.all([
                        fetch('m.css'),
                        fetch('page.css')
                    ]);
                    
                    const contents = await Promise.all(
                        responses.map(response => response.text())
                    );
                    
                    cssContent = contents.join('\n');
                    cssLoaded = true;
                    console.log('CSS loaded successfully');
                    console.log(cssContent);
                } catch (error) {
                    console.error('Error loading CSS:', error);
                    // Fallback: try to get styles from document
                    const styleSheets = Array.from(document.styleSheets);
                    cssContent = styleSheets.map(sheet => {
                        try {
                            return Array.from(sheet.cssRules)
                                .map(rule => rule.cssText)
                                .join('\n');
                        } catch (e) {
                            console.warn('Could not read stylesheet:', e);
                            return '';
                        }
                    }).join('\n');
                    
                    if (cssContent) {
                        cssLoaded = true;
                    }
                   
                }
            }

            // Add close button styles
            const style = document.createElement('style');
            style.textContent = `
                .close-button {
                    position: absolute;
                    top: var(--spacing-m);
                    right: var(--spacing-m);
                    width: 24px;
                    height: 24px;
                    border-radius: var(--radius-s);
                    background: var(--color-secondary);
                    border: none;
                    cursor: pointer;
                    display: none;
                    align-items: center;
                    justify-content: center;
                    color: var(--color-text);
                    font-size: var(--font-size-base);
                    transition: var(--transition-fast);
                }
                .close-button:hover {
                    background: var(--color-secondary-hover);
                }
                .close-button.visible {
                    display: flex;
                }
            `;
            document.head.appendChild(style);

            // Add close button to panel
            const closeButton = document.createElement('button');
            closeButton.className = 'close-button';
            closeButton.innerHTML = '×';
            closeButton.title = 'Show all variables';
            panel.appendChild(closeButton);

            // Function to show all variables
            async function showAllVariables() {
                if (!cssLoaded) {
                    await loadCSSContent();
                }
                
                // Add instruction message to element tree
                elementTree.innerHTML = `
                    <div class="text-small text-color-secondary mono-font" style="text-align: center;">
                        Click on any element to inspect
                    </div>`;
                
                // Get variables from .all-classes
                const allClassesVariables = findVariablesInCSS(['all-classes']);
                displayVariables(allClassesVariables);
                
                // Hide close button
                closeButton.classList.remove('visible');
            }

            // Add click handler for close button
            closeButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showAllVariables();
            });

            // Modify processElementClick to show close button
            async function processElementClick(target) {
                if (!cssLoaded) {
                    await loadCSSContent();
                }
                
                // Get element tree
                const tree = getElementTree(target);
                elementTree.innerHTML = displayElementTree(tree);
                
                // Get and display CSS variables
                const variables = getComputedVariables(target);
                displayVariables(variables);
                
                // Show close button
                closeButton.classList.add('visible');
            }

            function getAllClassesForElement(element) {
                const classes = new Set();
                
                // Get classes from the current element
                if (element.className) {
                    element.className.split(' ').forEach(cls => classes.add(cls));
                }
                
                // Get classes from parent elements (for inheritance)
                let parent = element.parentElement;
                while (parent && parent !== document.body) {
                    if (parent.className) {
                        parent.className.split(' ').forEach(cls => classes.add(cls));
                    }
                    parent = parent.parentElement;
                }
                
                return Array.from(classes);
            }

            function findVariablesInCSS(classes) {
                const variablesByClass = new Map();

                function extractVariables(cssValue) {
                    const matches = cssValue.match(/var\((--[^,)]+)/g);
                    if (matches) {
                        return matches.map(match => match.slice(4));
                    }
                    return [];
                }

                classes.forEach(className => {
                    const escapedClass = className.replace(/([.*+?^${}()|\[\]\\])/g, '\\$1');
                    const pattern = new RegExp(`\\.${escapedClass}(?:[^a-zA-Z0-9-_]|$)[^{]*{[^}]*}`, 'g');
                    
                    const matches = cssContent.match(pattern);
                    if (matches) {
                        const classVariables = [];
                        
                        matches.forEach(rule => {
                            const declarations = rule.match(/[^{]*{([^}]*)}/)[1];
                            const properties = declarations.split(';');
                            
                            properties.forEach(prop => {
                                if (prop.includes('var(--')) {
                                    const [property, value] = prop.split(':').map(s => s.trim());
                                    if (property && value) {
                                        const vars = extractVariables(value);
                                        vars.forEach(varName => {
                                            // Skip color variables
                                            if (varName.startsWith('--color-')) return;
                                            
                                            const exists = classVariables.some(v => 
                                                v.property === property && 
                                                v.variable === varName &&
                                                v.rule === rule.match(/[^{]*/)[0].trim()
                                            );
                                            
                                            if (!exists) {
                                                const computedValue = getComputedStyle(document.documentElement)
                                                    .getPropertyValue(varName).trim();
                                                classVariables.push({
                                                    property,
                                                    variable: varName,
                                                    computedValue,
                                                    rule: rule.match(/[^{]*/)[0].trim()
                                                });
                                            }
                                        });
                                    }
                                }
                            });
                        });

                        if (classVariables.length > 0) {
                            variablesByClass.set(className, classVariables);
                        }
                    }
                });

                return variablesByClass;
            }

            // Add this new function to handle variable overrides
            function handleVariableOverride(variable, value) {
                document.documentElement.style.setProperty(variable, value);
                // Update color dot if it's a main color
                if (variable.startsWith('--color-')) {
                    const dot = document.querySelector(`[data-variable="${variable}"]`).parentElement.querySelector('.color-dot');
                    if (dot) {
                        dot.style.background = value;
                    }
                }

                // Update the variables display without recreating inputs
                if (currentVariablesByClass) {
                    // Update the stored values in currentVariablesByClass
                    for (const [_, variables] of currentVariablesByClass) {
                        variables.forEach(v => {
                            if (v.variable === variable) {
                                v.computedValue = value;
                                // Find and update the display value
                                const variableItems = document.querySelectorAll('.variable-item');
                                variableItems.forEach(item => {
                                    const nameElement = item.querySelector('.variable-name');
                                    if (nameElement && nameElement.textContent === variable) {
                                        const valueElement = item.querySelector('.variable-value');
                                        if (valueElement) {
                                            valueElement.textContent = value;
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
            }

            function displayVariables(variablesByClass, filterClass = null) {
                const html = [];

                console.log(variablesByClass.get(filterClass));
                console.log(filterClass);
                if ((variablesByClass && filterClass && !(variablesByClass.get(filterClass)))) {

                        console.log('no vars');
                    html.push(`<div class="text-small text-color-secondary mono-font">
                        ${filterClass ? 
                            `No CSS variables found for .${filterClass}` : 
                            'No CSS variables found on this element'}
                    </div>`);
                }

                // Store current state
                currentVariablesByClass = variablesByClass;
                activeFilter = filterClass;

                
                // Create override controls section if it doesn't exist
                if (!document.getElementById('variableOverrides')) {
                    const overridesSection = document.createElement('div');
                    overridesSection.id = 'variableOverrides';
                    overridesSection.className = 'variable-overrides';
                    document.querySelector('.css-variables').appendChild(overridesSection);
                }

                // Filter classes if a specific class is selected
                const classEntries = Array.from(variablesByClass.entries());
                const filteredEntries = filterClass 
                    ? classEntries.filter(([className]) => className === filterClass)
                    : classEntries;

                for (const [className, variables] of filteredEntries) {
                    // Filter out the main color variables and placeholder properties
                    const filteredVariables = variables.filter(v => 
                        !['--color-black', '--color-spark', '--color-white'].includes(v.variable) &&
                        v.property !== 'placeholder'
                    );
                    
                    if (filteredVariables.length === 0) continue;

                    html.push(`
                        <div class="class-section ${filterClass === className ? 'active-class' : ''}">
                            <h4 class="text-small" style="color: var(--color-text-secondary)">
                                ${className}
                            </h4>
                            <div class="variable-group">
                                ${filteredVariables.map(({property, variable, computedValue, rule}) => `
                                    <div class="variable-item">
                                        <div>
                                            <span>${property}: <span class="variable-name">${variable}</span></span>
                                        </div>
                                        <span class="variable-value">${computedValue}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `);
                }

                variablesDisplay.innerHTML = html.join('');

                // Update override controls with filtered variables
                const overridesSection = document.getElementById('variableOverrides');
                const uniqueVariables = new Set();
                
                // Include both regular and placeholder variables in overrides
                filteredEntries.forEach(([_, variables]) => {
                    variables.forEach(({variable, property}) => {
                        if (!['--color-black', '--color-spark', '--color-white'].includes(variable)) {
                            uniqueVariables.add(variable);
                        }
                    });
                });

                overridesSection.innerHTML = `
                
                    ${uniqueVariables.size === 0 ? 
                        `<div class="text-small text-color-secondary mono-font">No Overrides</div>` :
                        `    <h4 class="text-small text-color-secondary mono-font padding-bottom">
                         Override Variables
                    </h4>` + Array.from(uniqueVariables).map(variable => {
                            // Get the current value from the computed style
                            const currentValue = getComputedStyle(document.documentElement)
                                .getPropertyValue(variable).trim();
                            return `
                                <div class="override-control">
                                    <span class="variable-name mono-font" style="width: 100%;">${variable}</span>
                                    <input type="text" 
                                           value="${currentValue}"
                                           data-variable="${variable}"
                                           class="variable-input mono-font">
                                </div>
                            `;
                        }).join('')
                    }
                `;

                // Add event listeners for override inputs
                document.querySelectorAll('.variable-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const variable = e.target.dataset.variable;
                        const value = e.target.value;
                        handleVariableOverride(variable, value);
                    });
                });
            }

            function getComputedVariables(element) {
                const classes = getAllClassesForElement(element);
                return findVariablesInCSS(classes);
            }

            // Make all elements with classes contenteditable and add data-classes
            document.querySelectorAll('*[class]').forEach(element => {
                // Skip elements inside the class panel
                if (!panel.contains(element)) {
                    element.setAttribute('contenteditable', 'true');
                    element.setAttribute('data-classes', element.className);
                }
            });

            function getElementTree(element) {
                const tree = [];
                let currentElement = element;
                
                // Start from the clicked element and go up to body
                while (currentElement && currentElement !== document.body) {
                    const classes = currentElement.className;
                    if (classes) { // Only add elements that have classes
                        tree.unshift({
                            tag: currentElement.tagName.toLowerCase(),
                            classes: classes,
                            isTarget: currentElement === element
                        });
                    }
                    currentElement = currentElement.parentElement;
                }
                
                // Add body if it has classes
                if (document.body.className) {
                    tree.unshift({
                        tag: 'body',
                        classes: document.body.className,
                        isTarget: element === document.body
                    });
                }
                
                return tree;
            }

            function displayElementTree(tree) {
                return tree.map((item, index) => {
                    const indent = `<span class="indent">__</span>`.repeat(index);
                    const arrow = index > 0 ? '<span class="indent-arrow">↪︎</span>' : '';
                    const classes = item.classes 
                        ? ' ' + item.classes.split(' ')
                            .map(cls => `
                                <span class="m-tag clickable-tag" data-class="${cls}">
                                    .${cls}
                                </span>
                            `)
                            .join(' ')
                        : '';
                    const className = item.isTarget ? 'element-tree-item active' : 'element-tree-item';
                    return `
                        <div class="tree-item" data-tree-item>
                            ${indent}${arrow}<span class="m-tag">&lt;${item.tag}&gt;${classes}</span>
                        </div>
                    `;
                }).join('\n');
            }

            // Handle click events
            document.addEventListener('click', (e) => {
                // Handle clicks on class tags in the tree
                if (e.target.classList.contains('clickable-tag')) {
                    e.stopPropagation();
                    const className = e.target.dataset.class;
                    
                    // Remove active state from all tags
                    document.querySelectorAll('.clickable-tag').forEach(tag => {
                        tag.classList.remove('active');
                    });

                    // If clicking the same class again or clicking outside, remove filter
                    if (activeFilter === className) {
                        activeFilter = null;
                    } else {
                        // Add active state to clicked tag
                        e.target.classList.add('active');
                        activeFilter = className;
                    }

                    // Redisplay variables with filter
                    if (currentVariablesByClass) {
                        displayVariables(currentVariablesByClass, activeFilter);
                    }
                    return;
                }

                // Handle clicks on tree items (but not on tags)
                if (e.target.closest('[data-tree-item]')) {
                    if (!e.target.classList.contains('clickable-tag')) {
                        // Remove active state from all tags
                        document.querySelectorAll('.clickable-tag').forEach(tag => {
                            tag.classList.remove('active');
                        });
                        
                        // Reset to unfiltered view
                        if (currentVariablesByClass) {
                            activeFilter = null;
                            displayVariables(currentVariablesByClass);
                        }
                    }
                    return;
                }

                // Skip if clicking inside the panel
                if (panel.contains(e.target)) {
                    return;
                }

                // Original element click handling
                let target = e.target;
                while (target && !target.className && target !== document.body) {
                    target = target.parentElement;
                }

                if (target && target.className) {
                    e.stopPropagation();
                    processElementClick(target);
                }
            });

            // Initial load - show all variables
            loadCSSContent().then(() => {
                showAllVariables();
            });

            // Add arrow key functionality for numeric inputs
            function handleArrowKeys(e) {
                // Skip if it's a color input
                if (e.target.matches('.color-input')) return;
                
                if (!e.target.matches('.variable-input')) return;
                const value = e.target.value;
                // Only process if the value contains numbers
                if (!/\d/.test(value)) return;

                const isShift = e.shiftKey;
                const step = isShift ? 10 : 1;
                
                let newValue;
                
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    
                    // Extract number and unit
                    const match = value.match(/([-\d.]+)([a-z%]*)$/i);
                    if (!match) return;
                    
                    const num = parseFloat(match[1]);
                    const unit = match[2] || '';
                    
                    // Calculate new value
                    newValue = e.key === 'ArrowUp' 
                        ? num + step 
                        : num - step;
                    
                    // Apply the change
                    e.target.value = newValue + unit;
                    
                    // Trigger the change
                    const variable = e.target.dataset.variable;
                    handleVariableOverride(variable, e.target.value);
                }
            }

            // Add keydown event listener for arrow keys
            document.addEventListener('keydown', handleArrowKeys);

            // Add download functionality
            document.querySelector('.download-button').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Get the original CSS content
                fetch('m.css')
                    .then(response => response.text())
                    .then(css => {
                        // Get all color variables
                        const colorVars = ['--color-black', '--color-spark', '--color-white'];
                        
                        // Replace the color variables with current values
                        colorVars.forEach(variable => {
                            const currentValue = getComputedStyle(document.documentElement)
                                .getPropertyValue(variable).trim();
                            const regex = new RegExp(`(${variable}:\\s*)[^;]+`);
                            css = css.replace(regex, `$1${currentValue}`);
                        });

                        // Create and trigger download
                        const blob = new Blob([css], { type: 'text/css' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'm.css';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    });

                // Process the click for element selection
                processElementClick(e.target);
            });

            // Add color picker handlers
            document.querySelectorAll('.color-dot input[type="color"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const variable = e.target.dataset.variable;
                    const value = e.target.value.toUpperCase();
                    handleVariableOverride(variable, value);
                    // Update the text input as well
                    const textInput = document.querySelector(`input[type="text"][data-variable="${variable}"]`);
                    if (textInput) {
                        textInput.value = value;
                    }
                });
            });

            // Add text input handlers for colors
            document.querySelectorAll('.color-input').forEach(input => {
                // Handle Enter key
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const variable = e.target.dataset.variable;
                        const value = e.target.value.toUpperCase();
                        handleVariableOverride(variable, value);
                        // Update the color picker as well
                        const colorPicker = document.querySelector(`input[type="color"][data-variable="${variable}"]`);
                        if (colorPicker) {
                            colorPicker.value = value;
                        }
                        input.blur();
                    }
                });

                // Handle focus out
                input.addEventListener('focusout', (e) => {
                    const variable = e.target.dataset.variable;
                    const value = e.target.value.toUpperCase();
                    handleVariableOverride(variable, value);
                    // Update the color picker as well
                    const colorPicker = document.querySelector(`input[type="color"][data-variable="${variable}"]`);
                    if (colorPicker) {
                        colorPicker.value = value;
                    }
                });
            });

            // Add this helper function for the :contains selector
            function addContainsSelector() {
                if (!jQuery) {
                    // Pure JS implementation of contains selector
                    if (!Element.prototype.matches) {
                        Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
                    }
                    const contains = (selector, text) => {
                        const elements = document.querySelectorAll(selector);
                        return Array.from(elements).filter(element => element.textContent.includes(text));
                    };
                    document.querySelector = ((originalFn) => {
                        return function(selector) {
                            if (selector.includes(':contains')) {
                                const [elementSelector, containsText] = selector.split(':contains');
                                const text = containsText.slice(2, -2); // Remove parentheses and quotes
                                return contains(elementSelector, text)[0];
                            }
                            return originalFn.call(document, selector);
                        };
                    })(document.querySelector);
                }
            }

            // Call this when the page loads
            addContainsSelector();
        });
    </script>
</body>
</html>
